# local-rag

> **Note:** This project was fully generated by Claude Opus 4.6 (Anthropic). All code, documentation, and configuration were written by the AI model through interactive development sessions using Claude Code.

A fully local, privacy-preserving RAG (Retrieval Augmented Generation) system for macOS. Indexes personal knowledge from multiple sources into a single SQLite database with hybrid vector + full-text search. Nothing leaves your machine.

## What It Does

local-rag indexes content from your local apps and files, then lets you search across all of it — either from the command line or directly from Claude Desktop / Claude Code via MCP.

**Supported sources:**

| Source | What's Indexed |
|--------|---------------|
| **Obsidian** | All files in your vault (.md, .pdf, .docx, .html, .epub, .txt) |
| **eM Client** | Emails (subject, body, sender, recipients, date) |
| **Calibre** | Ebook content and metadata (EPUB, PDF) |
| **NetNewsWire** | RSS/Atom articles |
| **Git repos** | Code files with structural parsing (Python, Go, TypeScript, Rust, Java, C, and more), plus data/config files (JSON, YAML, TOML, SQL, Markdown, HTML, CSS, XML, Makefile, TXT, CSV) |
| **Project folders** | Any folder of documents, dispatched to the right parser by file type |

## Prerequisites

- macOS
- [Homebrew](https://brew.sh)

```bash
brew install ollama uv
ollama pull bge-m3
```

Ollama runs as a background service on macOS after installation. Verify with `curl http://localhost:11434`.

## Getting Started

No installation step needed — `uv run` handles the virtual environment automatically.

### 1. Configure (optional)

Create `~/.local-rag/config.json` to set paths for your sources. See [config.example.json](config.example.json) for all available options.

To disable indexing for a collection without deleting its existing data, add it to `disabled_collections`:

```json
{
  "disabled_collections": ["email", "rss"]
}
```

Works with any collection name: system collections (`obsidian`, `email`, `calibre`, `rss`) or user-created ones (repo names, project names).

If you skip this step, you can pass paths directly on the command line.

### 2. Index Your Content

```bash
# Index Obsidian vault (from config or explicit path)
uv run local-rag index obsidian
uv run local-rag index obsidian --vault ~/Documents/MyVault

# Index eM Client emails
uv run local-rag index email

# Index Calibre ebook libraries
uv run local-rag index calibre
uv run local-rag index calibre --library ~/CalibreLibrary

# Index NetNewsWire RSS articles
uv run local-rag index rss

# Index code groups (repos grouped by org/topic in config)
uv run local-rag index group my-org            # index one group
uv run local-rag index group                   # index all groups
uv run local-rag index group my-org --history  # include commit history

# Index a folder of documents into a named project
uv run local-rag index project "Client X" ~/Documents/client-x-docs/

# Index all configured sources at once
uv run local-rag index all
```

All index commands support `--force` to re-index everything regardless of change detection.

### 3. Search

```bash
uv run local-rag search "kubernetes deployment strategy"
uv run local-rag search "invoice from supplier" --collection email
uv run local-rag search "API specification" --collection "Client X"
uv run local-rag search "budget report" --type pdf --after 2025-01-01
```

### 4. Use with Claude

There are two ways to run the MCP server: **standalone** (CLI) or via the **GUI menu bar app**.

#### Option A: Standalone (stdio)

Claude manages the server process directly. Best for Claude Code projects.

```bash
uv run local-rag serve
```

**Claude Code** — add to your project's `.mcp.json`:
```json
{
  "mcpServers": {
    "local-rag": {
      "command": "uv",
      "args": ["run", "--directory", "/path/to/local-rag", "local-rag", "serve"]
    }
  }
}
```

**Claude Desktop** — add to `~/Library/Application Support/Claude/claude_desktop_config.json`:
```json
{
  "mcpServers": {
    "local-rag": {
      "command": "uv",
      "args": ["run", "--directory", "/path/to/local-rag", "local-rag", "serve"]
    }
  }
}
```

#### Option B: GUI menu bar app (SSE)

The GUI runs a persistent MCP server on port 31123 (configurable) and provides a menu bar icon for managing indexing, settings, and server status.

```bash
uv run --extra gui local-rag-gui
```

The GUI auto-starts the MCP server on launch. Claude connects to it over SSE.

**Claude Code** — run in your project directory:
```bash
claude mcp add --transport sse local-rag http://localhost:31123/sse
```

**Claude Desktop** — Claude Desktop only supports stdio transports natively, so you need a bridge. Add to `~/Library/Application Support/Claude/claude_desktop_config.json`:
```json
{
  "mcpServers": {
    "local-rag": {
      "command": "uvx",
      "args": ["mcp-proxy", "http://localhost:31123/sse"]
    }
  }
}
```

This uses [mcp-proxy](https://github.com/punkpeye/mcp-proxy) to bridge stdio to SSE. Install it once with `uvx mcp-proxy --help` to verify it works.

Once connected, Claude can search your indexed knowledge using the `rag_search` tool.

## CLI Reference

```
local-rag index obsidian [--vault PATH] [--force]      Index Obsidian vault(s)
local-rag index email [--force]                        Index eM Client emails
local-rag index calibre [--library PATH] [--force]     Index Calibre ebook libraries
local-rag index rss [--force]                          Index NetNewsWire RSS articles
local-rag index group [NAME] [--history] [--force]     Index code group(s) from config
local-rag index project NAME [PATHS...] [--force]      Index docs into a project
local-rag index all [--force]                          Index all configured sources

local-rag search QUERY [options]                     Hybrid search across collections
  --collection NAME                                  Search within a specific collection
  --type TYPE                                        Filter by source type (pdf, markdown, email, ...)
  --author TEXT                                      Filter by book author
  --after DATE                                       Only results after this date (YYYY-MM-DD)
  --before DATE                                      Only results before this date (YYYY-MM-DD)
  --top N                                            Number of results (default: 10)

local-rag collections list                           List all collections
local-rag collections info NAME                      Detailed collection info
local-rag collections delete NAME                    Delete a collection and all its data

local-rag status                                     Show database stats
local-rag serve [--port PORT]                        Start MCP server (stdio or HTTP/SSE)
```

## How It Works

local-rag uses a hybrid search approach combining semantic vector search with keyword full-text search:

1. **Indexing**: Documents are parsed, split into chunks (~500 tokens), and embedded locally using Ollama (bge-m3 model). Chunks, embeddings, and metadata are stored in SQLite.
2. **Search**: Your query is embedded and compared against stored vectors (semantic match) AND searched via FTS5 (keyword match). Results are merged using Reciprocal Rank Fusion.

Everything runs locally — embeddings are generated on your machine by Ollama, and the database is a single SQLite file.

## Menu Bar GUI

The GUI provides a macOS menu bar app for managing local-rag without the terminal. It handles MCP server lifecycle, indexing, and configuration through a native interface.

**Features:**
- Start/stop MCP server from the menu bar
- Index individual collections or all at once
- Configure sources, code groups, and search settings via a Settings window
- View collection stats (source counts, chunk counts, last indexed)
- View server and indexing logs
- Register with Claude Desktop or Claude Code in one click

**Running the GUI:**

```bash
uv run --extra gui local-rag-gui
```

The GUI and CLI share the same config file (`~/.local-rag/config.json`) and database, so you can use both interchangeably.

## Automatic Startup with launchd

macOS launchd user agents can auto-start local-rag on login. Unlike cron, launchd catches up on missed runs after your Mac wakes from sleep.

### Option A: GUI menu bar app (recommended)

Starts the GUI on login. The GUI manages the MCP server and can be configured for automatic re-indexing from the Settings window.

Run this from the local-rag repository directory:

```bash
cat > ~/Library/LaunchAgents/com.local-rag.gui.plist << EOF
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>Label</key>
    <string>com.local-rag.gui</string>

    <key>ProgramArguments</key>
    <array>
        <string>$(which uv)</string>
        <string>run</string>
        <string>--extra</string>
        <string>gui</string>
        <string>--directory</string>
        <string>$PWD</string>
        <string>local-rag-gui</string>
    </array>

    <key>EnvironmentVariables</key>
    <dict>
        <key>PATH</key>
        <string>$(dirname $(which uv)):/usr/local/bin:/usr/bin:/bin</string>
    </dict>

    <!-- Log output to ~/.local-rag/gui.log -->
    <key>StandardOutPath</key>
    <string>$HOME/.local-rag/gui.log</string>
    <key>StandardErrorPath</key>
    <string>$HOME/.local-rag/gui.log</string>

    <!-- Start on login -->
    <key>RunAtLoad</key>
    <true/>

    <!-- Keep running (restart if it crashes) -->
    <key>KeepAlive</key>
    <true/>
</dict>
</plist>
EOF
```

Load it:

```bash
launchctl load ~/Library/LaunchAgents/com.local-rag.gui.plist
```

### Option B: CLI indexing only (no GUI)

Runs `index all` on a schedule. Use this if you don't need the GUI and only want periodic re-indexing.

Run this from the local-rag repository directory:

```bash
cat > ~/Library/LaunchAgents/com.local-rag.index.plist << EOF
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>Label</key>
    <string>com.local-rag.index</string>

    <key>ProgramArguments</key>
    <array>
        <string>$(which uv)</string>
        <string>run</string>
        <string>--directory</string>
        <string>$PWD</string>
        <string>local-rag</string>
        <string>index</string>
        <string>all</string>
    </array>

    <key>EnvironmentVariables</key>
    <dict>
        <key>PATH</key>
        <string>$(dirname $(which uv)):/usr/local/bin:/usr/bin:/bin</string>
    </dict>

    <!-- Run every 2 hours (7200 seconds) -->
    <key>StartInterval</key>
    <integer>7200</integer>

    <!-- Log output to ~/.local-rag/index.log -->
    <key>StandardOutPath</key>
    <string>$HOME/.local-rag/index.log</string>
    <key>StandardErrorPath</key>
    <string>$HOME/.local-rag/index.log</string>

    <!-- Run once immediately when loaded -->
    <key>RunAtLoad</key>
    <true/>
</dict>
</plist>
EOF
```

Load it:

```bash
launchctl load ~/Library/LaunchAgents/com.local-rag.index.plist
```

### Managing launchd agents

```bash
# Check status
launchctl list | grep local-rag

# View logs
tail -f ~/.local-rag/gui.log    # GUI agent
tail -f ~/.local-rag/index.log  # Index agent

# Stop and unload
launchctl unload ~/Library/LaunchAgents/com.local-rag.gui.plist
launchctl unload ~/Library/LaunchAgents/com.local-rag.index.plist

# Reload after editing the plist
launchctl unload ~/Library/LaunchAgents/com.local-rag.gui.plist
launchctl load ~/Library/LaunchAgents/com.local-rag.gui.plist
```

### Plist fields reference

| Field | Purpose |
|-------|---------|
| `Label` | Unique identifier for the job |
| `ProgramArguments` | Command to run, split into argv array |
| `EnvironmentVariables` | Sets `PATH` so launchd can find `uv` and `ollama` (launchd jobs start with a minimal environment) |
| `StartInterval` | Run every N seconds (7200 = 2 hours). Only used for the index agent. |
| `KeepAlive` | Restart the process if it exits. Only used for the GUI agent. |
| `StandardOutPath/ErrorPath` | Where stdout/stderr are written |
| `RunAtLoad` | Run immediately when the agent is loaded (on login or after `launchctl load`) |

## Documentation

- [Architecture overview](docs/architecture.md) — system design, data flow, database schema, supported file types
- [Ollama and embeddings](docs/ollama-and-embeddings.md) — what Ollama does, how embeddings work, model configuration
- [Hybrid search and RRF](docs/hybrid-search-and-rrf.md) — how vector + keyword search are combined
- [eM Client schema](docs/emclient-schema.md) — eM Client database structure and how emails are extracted

## Tech Stack

| Component | Choice |
|-----------|--------|
| Language | Python 3.13+ |
| Database | SQLite + sqlite-vec + FTS5 |
| Embeddings | Ollama + bge-m3 (1024d) |
| PDF parsing | pymupdf |
| DOCX parsing | python-docx |
| EPUB parsing | zipfile + BeautifulSoup |
| Code parsing | tree-sitter |
| CLI | click |
| MCP server | mcp Python SDK (FastMCP) |
| Menu bar GUI | rumps + PySide6 (optional) |

## License

This project is licensed under the [MIT License](LICENSE).

**Note on PyMuPDF (pymupdf):** The PDF parsing dependency
[PyMuPDF](https://pymupdf.readthedocs.io/) is dual-licensed under
**GNU AGPL 3.0** and a commercial Artifex license. If the AGPL terms are
not acceptable for your use case, you can obtain a
[commercial license from Artifex](https://artifex.com/products/pymupdf/)
or replace pymupdf with an alternative PDF library (e.g. `pypdf`, BSD).
All other dependencies use permissive licenses (MIT, BSD, Apache 2.0).
